/* global browser, $, it, describe, before */

var chai = require('chai');
var chaiAsPromised = require('chai-as-promised');
var conditions = require('../lib/conditions');
var expect = chai.expect;
var locators = require('../lib/locators');
var url = require('url');
var when = require('mocha-bdd-when');

chai.use(chaiAsPromised);

describe('#check Search', function () {
    before(function () {
        return browser.wait(function () {
            return browser.get('/console?ctrl=Header&m_id=tdv2-applet-uh').then(function () {
                return true;
            });
        });
    });

    when(conditions['#base']).describe('#base', function () {
        it('should exist', function () {
            var search = $(locators.Search);
            var searchInput = $(locators.SearchInput);
            var searchBtn = $(locators.SearchBtn);
            browser.waitToBePresent(search);
            expect(search.isPresent()).not.to.equal(false);
            expect(searchInput.isPresent()).not.to.equal(false);
            expect(searchBtn.isPresent()).not.to.equal(false);
        });

        it('form has action defined', function () {
            var form = $(locators.SearchForm);

            form.getAttribute('action').then(function(action) {
                var actual = url.parse(action);
                actual.protocol = 'https';
                actual = url.format(actual);
                expect(actual).to.be.deep.equal('https://search.yahoo.com/search');
            });
        });

        it('should show search assist when keyword is entered', function() {
            var searchInput = $(locators.SearchInput);
            var acList;
            searchInput.sendKeys('yahoo');
            acList = $(locators.acList);
            expect(acList.isPresent()).to.eventually.equal(true);
        });

        it('go to search.yahoo.com when searched', function () {
            var searchInput = $(locators.SearchInput);
            var searchBtn = $(locators.SearchBtn);

            searchInput.sendKeys(' mail');

            searchBtn.click().then(function() {
                browser.waitToBePresent($(locators.sycInput));
                browser.getCurrentUrl().then(function(url) {
                    expect(url).to.contain('search.yahoo.com');
                });
            });
        });
    });
});
