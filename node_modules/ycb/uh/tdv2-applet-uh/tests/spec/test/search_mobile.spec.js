/* global browser, document, protractor, $, it, describe, before */

var chai = require('chai');
var chaiAsPromised = require('chai-as-promised');
var conditions = require('../lib/conditions');
var expect = chai.expect;
var locators = require('../lib/locators');
var url = require('url');
var when = require('mocha-bdd-when');

chai.use(chaiAsPromised);

describe('#check Search Mobile', function () {
    before(function () {
        return browser.wait(function () {
            return browser.get('/console?ctrl=MobileHeader&m_id=tdv2-applet-uh&device=smartphone').then(function () {
                return true;
            });
        });
    });

    when(conditions['#base']).describe('#base', function () {
        it('should exist', function () {
            var search = $(locators.SearchMobile);
            var searchInput = $(locators.SearchInputMobile);
            var searchCancel = $(locators.SearchCancelMobile);
            browser.waitToBePresent(search);
            expect(search.isPresent()).not.to.equal(false);
            expect(searchInput.isPresent()).not.to.equal(false);
            expect(searchCancel.isPresent()).not.to.equal(false);
        });

        it('form has action defined', function () {
            var form = $(locators.SearchFormMobile);

            form.getAttribute('action').then(function(action) {
                var actual = url.parse(action);
                actual.protocol = 'https';
                actual = url.format(actual);
                expect(actual).to.be.deep.equal('https://search.yahoo.com/search');
            });
        });

        it('should show Cancel when overlay is shown', function() {
            var searchInput = $(locators.SearchInputMobile);
            searchInput.sendKeys('yahoo');
            browser.waitToBePresent($(locators.SearchOpen));
            browser.driver.executeScript(function() {
                return document.documentElement.classList;
            }).then(function(result) {
                expect(result).to.contain('uh-search-open');
            });
        });

        it('should show search assist when keyword is entered', function() {
            var searchInput = $(locators.SearchInputMobile);
            var acList;
            searchInput.sendKeys(' mail');
            acList = $(locators.acList);
            expect(acList.isPresent()).to.eventually.equal(true);
        });

        it('go to search.yahoo.com when searched', function () {
            var searchInput = $(locators.SearchInputMobile);

            searchInput.sendKeys(' login');
            searchInput.sendKeys(protractor.Key.ENTER).then(function() {
                // browser.waitToBePresent($(locators.sycInput));
                browser.getCurrentUrl().then(function(url) {
                    expect(url).to.contain('search.yahoo.com');
                });
            });
        });
    });
});
