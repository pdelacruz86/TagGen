/*global global, require, before, after, beforeEach, describe, it */
/*jshint -W030, -W097 */
var _require = require('root-require');
var expect = require('chai').expect;
var Immutable = require('immutable');
var jsx = require('jsx-test').jsxTranspile(process.env.JENKINS_MOCHA_COVERAGE);
var MockContext = require('touchdown-v2/utils/MockComponentContext');
var mockery = require('mockery');
var HeaderStore = _require('stores/HeaderStore');
var NavStore = _require('stores/NavStore');
var RouteStore = require('fluxible-router/lib/RouteStore');

describe('components/nav/Topbar.jsx', function () {
    var Topbar;

    before(function () {
        mockery.registerMock(
            './TopbarItems',
            _require('tests/mock/components/nav/TopbarItems.jsx')
        );
        mockery.registerMock(
            'react-intl',
            _require('tests/mock/react-intl')
        );
        mockery.enable({
            useCleanCache: true,
            warnOnUnregistered: false
        });

        Topbar = _require('components/nav/Topbar.jsx');
    });

    after(function () {
        mockery.disable();
        mockery.deregisterAll();
    });

    describe('#component', function () {
        var component;

        beforeEach(function () {
            var context = MockContext({stores: [HeaderStore, RouteStore, NavStore]});
            context.conf = _require('tests/mock/config')
                .mergeDeep({
                    topbar: {
                        data: {
                            more: 2
                        }
                    }
                });
            context.session = _require('tests/mock/session').toJS();
            context.theme = _require('tests/mock/theme');

            component = jsx.withContext(Topbar, context);
        });

        it('should have displayName "Topbar:withContext"', function () {
            expect(component).to.be.ok;
            expect(component.displayName).to.be.equal('Topbar:withContext');
        });

        describe('#render', function () {
            var domNode;
            var renderedComponent;

            beforeEach(function () {
                renderedComponent = jsx.renderComponent(component);
                domNode = renderedComponent.getDOMNode();
            });

            it('should render correctly', function () {
                expect(renderedComponent).to.be.ok;

                expect(domNode.nodeName).to.be.equal('DIV');
                expect(domNode.id).to.be.equal('topbar-items');

                expect(domNode.querySelectorAll('#topbar-items .home').length).to.be.equal(0);
                expect(domNode.querySelectorAll('#topbar-items .main').length).to.be.equal(0);
                expect(domNode.querySelectorAll('#topbar-items .more').length).to.be.equal(0);
            });
        });

        describe('#render with props.data', function () {
            var domNode;
            var renderedComponent;

            beforeEach(function () {
                var data = Immutable.fromJS({
                    items: {
                        // MAIN
                        home: {
                            link: 'https://www.yahoo.com/',
                            order: 1,
                            parent: 'root',
                            title: 'Home'
                        },
                        mail: {
                            link: 'https://mail.yahoo.com/',
                            order: 2,
                            parent: 'root',
                            title: 'Mail'
                        },
                        // MORE
                        celebrity: {
                            link: 'https://celebrity.yahoo.com/',
                            order: 3,
                            parent: 'root',
                            title: 'Celebrity'
                        },
                        // HOME
                        home_att: {
                            link: 'https://att.yahoo.com/',
                            order: 1,
                            parent: 'home',
                            title: 'AT&T'
                        },
                        home_att_features: {
                            link: 'https://attfeatures.yahoo.com/',
                            order: 2,
                            parent: 'home',
                            title: 'AT&T Features'
                        },
                        home_news: {
                            link: 'https://attnews.yahoo.com/',
                            order: 3,
                            parent: 'home',
                            title: 'AT&T News'
                        }
                    }
                });
                renderedComponent = jsx.renderComponent(component, {data: data});
                domNode = renderedComponent.getDOMNode();
            });

            it('should render correctly', function () {
                expect(renderedComponent).to.be.ok;

                expect(domNode.nodeName).to.be.equal('DIV');
                expect(domNode.id).to.be.equal('topbar-items');

                expect(domNode.querySelectorAll('#topbar-items .home').length).to.be.equal(3);
                expect(domNode.querySelectorAll('#topbar-items .main').length).to.be.equal(3);
                expect(domNode.querySelectorAll('#topbar-items .more').length).to.be.equal(1);
            });
        });
    });
});
