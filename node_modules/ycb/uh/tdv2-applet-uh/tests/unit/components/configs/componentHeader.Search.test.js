/*global after, before, describe, it */
'use strict';
var rootRequire = require('root-require');
var testRequire = rootRequire('tests/lib/testRequire');

var commonDimensions = require('common-dimensions');
var ConfigHelper = require('ycb-config');
var expect = require('chai').expect;
var fs = require('fs');
var pkg = rootRequire('package.json');
var util = require('util');
var yaml = require('js-yaml');
var ycb = testRequire('configs/componentHeader');

describe('configs/componentHeader.js', function () {
    before(function() {
        this.bundleName = pkg.name;
        this.configHelper = new ConfigHelper();
        this.configHelper.addConfigContents(this.bundleName, 'dimensions', 'dimensions', commonDimensions);
        this.configHelper.addConfigContents(this.bundleName, 'config', 'config', ycb);
    });

    after(function() {
        this.bundleName = undefined;
        this.configHelper = undefined;
    });

    it('should be an Array', function () {
        expect(ycb).to.be.an('Array');
    });

    describe('Search', function () {
        describe('standard', function () {
            // single run with parameter { lang: 'en-US' }.
            describe('.single', function() {
                it ('{ lang: \'en-US\' }', function (done) {
                    this.configHelper.read(this.bundleName, 'config', {lang: 'en-US'},
                    function getConfig(err, config) {
                        var result = {
                            style: {
                                cancel_button: {},
                                container: {},
                                input: {},
                                search_button: {
                                    inline: {}
                                }
                            },
                            assistYlc: ';_ylc=X3oDMTFiaHBhMnJmBF9TAzIwMjM1Mzgw'+
                                    'NzUEaXRjAzEEc2VjA3NyY2hfcWEEc2xrA3NyY2hhc3Q-',
                            autocomplete: {
                                gossip: {
                                    url: {
                                        host: 'search.yahoo.com',
                                        path: '/sugg/gossip/gossip-us-ura/',
                                        query: {
                                            appid: 'yahoo.com',
                                            nresults: 10,
                                            output: 'sd1'
                                        }
                                    }
                                }
                            },
                            autofocus: true,
                            buttonText: 'SEARCH',
                            cancelBtn: false,
                            glowEnabled: false,
                            clearBtn: false,
                            instantSearch: false,
                            magnifyingGlass: false,
                            placeholderIcon: false,
                            placeholderText: 'SEARCH',
                            queries: {},
                            searchHint: false,
                            termCompleteBtn: false,
                            ylc: ';_ylc=X3oDMTFiN25laTRvBF9TAzIwMjM1Mzgw'+
                                'NzUEaXRjAzEEc2VjA3NyY2hfcWEEc2xrA3NyY2h3ZWI-'
                        };
                        var actual = config.uh.search;
                        expect(result).to.deep.equal(actual);
                        done();
                    });
                });
            });

            // parametric run with external data provider 'logo-cobrand.yaml'.
            describe('.parametric', function() {
                var data = yaml.safeLoad( fs.readFileSync('tests/data/search-config.yaml', 'utf8') );
                Object.keys(data).forEach(function getData(key) {
                    // Formulate the context object.
                    //
                    // input:
                    //      'lang:zh-Hant-HK'
                    //
                    // output:
                    //      {
                    //          lang: 'zh-Hant-HK'
                    //      }
                    //
                    var context = (function getContext(key) {
                        var data = {};
                        var kvps = key.split(',');
                        kvps.forEach(function processKV(kvs) {
                            var kv = kvs.split(':');
                            data[kv[0]] = kv[1];
                        });
                        return data;
                    }(key));

                    // Get the config given a context object.
                    it(util.inspect(context, {depth: null}), function (done) {
                        this.configHelper.read(this.bundleName, 'config', context, function getConfig(err, config) {
                            var result = data[key];
                            var actual = config.uh.search;
                            expect(result).to.deep.equal(actual);
                            done();
                        });
                    });
                });
            });
        });
    });
});
